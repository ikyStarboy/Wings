<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Realtime</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      background: url('https://raw.githubusercontent.com/ikyYourStar/ZedxChat/refs/heads/main/assets/Tak%20berjudul134_20250707192207.png') no-repeat center center fixed;
      background-size: cover;
    }
    body { display: flex; flex-direction: column; }

    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 3vw;
    }

    .msg {
      max-width: 75%;
      padding: 3vw;
      margin: 2vw 0;
      border-radius: 2vw;
      word-wrap: break-word;
      font-size: 4vw;
      position: relative;
      transition: transform 0.2s ease;
      will-change: transform;
    }

    .own { background: #dcf8c6; margin-left: auto; text-align: right; }
    .other { background: #e5e5ea; margin-right: auto; text-align: left; }

    .reply {
      font-size: 3.2vw;
      opacity: 0.6;
      margin-bottom: 1vw;
    }

    #reply-preview {
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 2vw;
      font-size: 3.5vw;
      display: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #reply-preview span {
      flex: 1;
    }

    #input-area {
      display: flex;
      gap: 2vw;
      padding: 2vw;
      background: #fff;
      border-top: 1px solid #ccc;
      align-items: center;
    }

    #input {
      flex: 1;
      padding: 2.5vw;
      font-size: 4vw;
      border: 1px solid #ccc;
      border-radius: 1vw;
    }

    #send {
      padding: 2.5vw 4vw;
      background: #4caf50;
      color: white;
      font-size: 4vw;
      border: none;
      border-radius: 1vw;
      cursor: pointer;
    }

    #uploadBtn {
      background: none;
      border: none;
      font-size: 6vw;
      cursor: pointer;
    }

    .msg img {
      max-width: 100%;
      border-radius: 1vw;
      margin-top: 1vw;
    }

    .time {
      font-size: 3vw;
      opacity: 0.5;
      display: block;
      margin-top: 1vw;
    }

    .own .time {
      text-align: right;
    }

    .other .time {
      text-align: left;
    }

    @media (min-width: 768px) {
      .msg { font-size: 16px; }
      .reply { font-size: 13px; }
      #input { font-size: 16px; }
      #send { font-size: 16px; }
      #uploadBtn { font-size: 24px; }
      .time { font-size: 12px; }
    }
  </style>
</head>
<body>

  <div id="chat-container"></div>

  <div id="reply-preview">
    <span id="reply-text"></span>
    <button onclick="cancelReply()" style="background:none;border:none;color:white;font-size:5vw;">Ã—</button>
  </div>

  <div id="input-area">
    <button id="uploadBtn">ðŸ“Ž</button>
    <input type="file" id="fileInput" accept="image/*" style="display:none;" />
    <input type="text" id="input" placeholder="Ketik pesan..." />
    <button id="send">Kirim</button>
  </div>

  <script>
    const imgbbKey = "a12e3657b8edd041c13eda8c12ff5925";
    const firebaseConfig = {
      apiKey: "AIzaSyCTjBsKdHmmTELY3wnfGYANEzzDBEF2BIo",
      authDomain: "realtime-df5d0.firebaseapp.com",
      databaseURL: "https://realtime-df5d0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "realtime-df5d0",
      storageBucket: "realtime-df5d0.appspot.com",
      messagingSenderId: "1065067984786",
      appId: "1:1065067984786:web:b315a080932587ec53f34b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let username = localStorage.getItem("username");
    if (!username) {
      username = prompt("Masukkan nama kamu:") || "Anonim";
      localStorage.setItem("username", username);
    }

    const chatContainer = document.getElementById("chat-container");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const replyPreview = document.getElementById("reply-preview");
    const replyText = document.getElementById("reply-text");
    let replyTo = null;

    function scrollToBottom() {
      setTimeout(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, 100);
    }

    function cancelReply() {
      replyTo = null;
      replyPreview.style.display = "none";
    }

    function renderMessage(key, data) {
      const div = document.createElement("div");
      const isOwn = data.user === username;
      div.classList.add("msg", isOwn ? "own" : "other");
      div.id = "msg-" + key;

      const time = new Date(data.timestamp || Date.now());
      const timeStr = time.getHours().toString().padStart(2, "0") + ":" +
                      time.getMinutes().toString().padStart(2, "0");

      if (data.deleted) {
        div.textContent = "Pesan ini telah dihapus";
        div.style.fontStyle = "italic";
        chatContainer.appendChild(div);
        scrollToBottom();
        return;
      }

      if (data.reply) {
        const replyDiv = document.createElement("div");
        replyDiv.className = "reply";
        replyDiv.textContent = data.reply.user + ": " + data.reply.message;
        div.appendChild(replyDiv);
      }

      const contentDiv = document.createElement("div");
      contentDiv.style.textAlign = isOwn ? "right" : "left";

      if (data.imageURL) {
        if (!isOwn) {
          const label = document.createElement("strong");
          label.textContent = data.user;
          contentDiv.appendChild(label);
          contentDiv.appendChild(document.createElement("br"));
        }
        const img = document.createElement("img");
        img.src = data.imageURL;
        img.alt = "gambar";
        contentDiv.appendChild(img);
      } else {
        const text = isOwn ? data.message : `${data.user}: ${data.message}`;
        const p = document.createElement("div");
        p.textContent = text;
        contentDiv.appendChild(p);
      }

      const timeEl = document.createElement("span");
      timeEl.className = "time";
      timeEl.textContent = timeStr;
      contentDiv.appendChild(document.createElement("br"));
      contentDiv.appendChild(timeEl);

      div.appendChild(contentDiv);
      chatContainer.appendChild(div);
      scrollToBottom();

      // Geser untuk reply
      let startX = 0, startY = 0, moved = false;
      div.addEventListener("touchstart", e => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      });
      div.addEventListener("touchmove", e => {
        const dx = e.touches[0].clientX - startX;
        const dy = e.touches[0].clientY - startY;
        if (Math.abs(dy) > Math.abs(dx)) return;
        if (dx > 0 && dx < 100) {
          moved = true;
          div.style.transform = `translateX(${dx}px)`;
        }
      });
      div.addEventListener("touchend", e => {
        const dx = e.changedTouches[0].clientX - startX;
        if (moved && dx > 60) {
          replyTo = { user: data.user, message: data.message || 'Gambar' };
          replyText.textContent = "Balas: " + replyTo.user + ": " + replyTo.message;
          replyPreview.style.display = "flex";
        }
        div.style.transform = "translateX(0)";
      });

      // Hapus pesan
      if (isOwn) {
        let timeout = null;
        div.addEventListener("touchstart", () => {
          timeout = setTimeout(() => {
            if (confirm("Hapus pesan ini?")) {
              db.ref("chats/" + key).update({ deleted: true });
            }
          }, 600);
        });
        div.addEventListener("touchend", () => clearTimeout(timeout));
      }
    }

    db.ref("chats").on("child_added", snap => renderMessage(snap.key, snap.val()));
    db.ref("chats").on("child_changed", snap => {
      const el = document.getElementById("msg-" + snap.key);
      if (el) el.remove();
      renderMessage(snap.key, snap.val());
    });

    sendBtn.onclick = () => {
      const message = input.value.trim();
      if (!message) return;

      const msgData = {
        user: username,
        message,
        timestamp: Date.now()
      };
      if (replyTo) msgData.reply = replyTo;

      db.ref("chats").push(msgData);
      input.value = "";
      cancelReply();
    };

    uploadBtn.onclick = () => fileInput.click();

    fileInput.onchange = () => {
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function () {
        const base64 = reader.result.split(',')[1];
        fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, {
          method: 'POST',
          body: new URLSearchParams({ image: base64 })
        })
        .then(res => res.json())
        .then(result => {
          const msgData = {
            user: username,
            imageURL: result.data.url,
            timestamp: Date.now()
          };
          if (replyTo) msgData.reply = replyTo;
          db.ref("chats").push(msgData);
          cancelReply();
        })
        .catch(err => alert("Gagal upload gambar"));
      };
      reader.readAsDataURL(file);
    };

    input.addEventListener("keypress", e => {
      if (e.key === "Enter") sendBtn.click();
    });
  </script>

</body>
</html>
