<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZedxChat</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="shared.js"></script>
    <style>
        /* Your existing CSS here */
        :root {
            /* Variabel CSS untuk tinggi total input area (input + reply preview) */
            --input-area-total-height: 70px; /* Default: Tinggi input area tanpa reply preview */
            --input-area-min-height: 50px; /* Tinggi minimum untuk #input-area */
            --reply-preview-height: 50px; /* Tinggi tetap untuk reply preview */
            --chat-message-spacing: 8px; /* Spasi antar pesan */
            --extra-bottom-padding: 10px; /* Tambahan padding di bawah pesan terakhir */
            --bottom-nav-height: 60px; /* Tinggi navigasi bawah */
        }

        * { box-sizing: border-box; }
        html, body {
            margin: 0; padding: 0; height: 100%;
            font-family: Arial, sans-serif;
            background: #202c33; /* Dark background like WhatsApp */
            color: #e9edef; /* Light text color */
            overflow: hidden; /* Prevent body scroll */
        }
        body { display: flex; flex-direction: column; } /* Menggunakan flexbox untuk layout utama */

        /* --- Loading Screen Styles --- */
        #loadingScreen {
            position: fixed; top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111b21; /* Match app background */
            display: flex;
            flex-direction: column; justify-content: center;
            align-items: center;
            color: #008069; /* WhatsApp Green */
            font-size: 1.5em; z-index: 9999; /* Ensure it's on top */
            transition: opacity 0.5s ease-out; opacity: 1;
        }

        #loadingSpinner {
            border: 4px solid rgba(0, 128, 105, 0.3); border-top: 4px solid #008069;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Auth Container Styles (Login/Register) --- */
        .auth-container {
            background-color: rgba(32, 44, 51, 0.9); /* Darker, slightly transparent */
            padding: 30px;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-sizing: border-box;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 102;
            display: none;
        }

        .auth-container h2 {
            margin-bottom: 25px; color: #e9edef;
        }

        .input-group {
            margin-bottom: 20px; text-align: left;
        }

        .input-group input {
            width: 100%; padding: 12px;
            border: 1px solid #555;
            border-radius: 5px;
            font-size: 16px;
            background-color: #33444d; /* Darker input background */
            color: #e9edef;
            box-sizing: border-box;
        }

        .button-group {
            display: flex; gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .button-group button {
            padding: 12px 25px; border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            color: white;
        }

        .auth-button { /* General style for login/register buttons */
            background-color: #008069; /* WhatsApp Green */
        }

        .auth-button:hover {
            background-color: #006b5a;
        }

        .switch-auth-mode {
            margin-top: 20px; font-size: 0.9em;
            color: #aebac1;
        }

        .switch-auth-mode a {
            color: #008069; text-decoration: none;
            font-weight: bold;
        }

        .auth-message { /* Combined style for login/register messages */
            margin-top: 20px; font-weight: bold;
            color: #ff6b6b; /* Error red */
        }

        /* --- Chat List (Lobby) Styles --- */
        #chatListContainer {
            display: flex; flex-direction: column;
            height: 100vh;
            width: 100%;
            background-color: #111b21; /* WhatsApp dark background */
            position: relative; overflow: hidden;
            display: none; /* Hidden by default */
        }

        #chatListHeader {
            display: flex; align-items: center;
            padding: 15px 20px;
            background-color: #202c33;
            color: #e9edef;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        #chatListHeader h1 {
            flex-grow: 1; margin: 0;
            font-size: 1.5em;
            text-align: left;
        }

        #chatListHeader button {
            background: none; border: none;
            color: #e9edef;
            font-size: 1.2em;
            cursor: pointer;
            margin-left: 15px;
        }

        #chatListContent {
            flex: 1; overflow-y: auto;
            padding: 0;
            padding-bottom: var(--bottom-nav-height); /* Add padding for bottom nav */
        }

        .chat-list-item {
            display: flex; align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #2a3942; /* Darker separator */
            cursor: pointer; transition: background-color 0.2s ease;
        }

        .chat-list-item:hover {
            background-color: #2a3942; /* Hover effect */
        }

        .chat-list-item:last-child {
            border-bottom: none;
        }

        .chat-avatar {
            width: 50px; height: 50px;
            border-radius: 50%;
            background-color: #008069; /* Default avatar background */
            display: flex; justify-content: center;
            align-items: center;
            font-size: 1.5em;
            color: white;
            margin-right: 15px;
            flex-shrink: 0;
        }

        /* --- Money Display in Lobby --- */
        #moneyDisplay {
            padding: 10px 20px; background-color: #1a252e;
            color: #e9edef;
            font-size: 1.1em;
            font-weight: bold;
            text-align: right;
            border-bottom: 1px solid #2a3942;
        }

        /* --- Bottom Navigation --- */
        #bottomNav {
            position: fixed; bottom: 0;
            left: 0;
            width: 100%;
            height: var(--bottom-nav-height);
            background-color: #202c33; /* Darker header */
            display: flex; justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
            z-index: 100;
            border-top: 1px solid #2a3942;
        }

        .nav-item {
            display: flex; flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: #aebac1; /* Default color */
            font-size: 0.8em;
            cursor: pointer; transition: color 0.2s ease;
        }

        .nav-item.active {
            color: #008069; /* Active color */
        }

        .nav-item i {
            font-size: 1.5em; margin-bottom: 3px;
        }

        /* --- Main Chat Content Styles --- */
        #main-content {
            flex: 1; display: flex;
            flex-direction: column;
            height: 100vh; /* Use 100vh for full screen chat */
            width: 100%; position: relative;
            background-color: #0b141a; /* WhatsApp chat background */
            display: none; /* Hidden by default */
        }

        #chat-header {
            display: flex; align-items: center;
            padding: 10px 15px;
            background-color: #202c33; /* Darker header */
            color: #e9edef; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        #chat-header button {
            background: none; border: none;
            color: #e9edef;
            font-size: 1.5em;
            cursor: pointer;
            margin-right: 15px;
        }

        #chat-header h2 {
            flex-grow: 1; margin: 0;
            font-size: 1.2em;
        }

        #chat-container {
            flex: 1; /* Penting agar container mengisi sisa ruang */
            overflow-y: auto; padding: 10px 15px; /* Padding samping dan atas */
            background-image: url('https://raw.githubusercontent.com/ikyYourStar/ZedxChat/refs/heads/main/assets/Tak%20berjudul134_20250707192207.png'); /* Your background image */
            background-size: cover;
            background-position: center; background-repeat: no-repeat;
            /* PERBAIKAN: Padding bawah dinamis agar pesan tidak tertutup input */
            padding-bottom: calc(var(--input-area-total-height) + var(--extra-bottom-padding));
        }

        .msg {
            max-width: 80%; /* Slightly wider messages */
            padding: 8px 12px; /* Adjust padding */
            margin-bottom: var(--chat-message-spacing); /* Spasi antar pesan */
            border-radius: 8px; /* Smaller border radius */
            word-wrap: break-word;
            font-size: 0.95em; /* Slightly smaller font for better fit */
            position: relative; transition: transform 0.2s ease; /* For swipe animation */
            will-change: transform;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        .own {
            background: #005c4b; /* Darker green for own messages */
            margin-left: auto; text-align: right;
        }

        .other {
            background: #202c33; /* Dark grey for other messages */
            margin-right: auto; text-align: left;
        }

        /* MODIFIKASI: Gaya khusus untuk pesan yang dihapus */
        .deleted-message {
            background-color: #303f4a; /* Slightly different background for deleted */
            opacity: 0.7; font-style: italic;
            color: #aebac1;
            /* Pastikan margin-left/right tidak auto jika ingin di tengah atau sesuai asal */
            margin-left: unset; /* Reset margin-left */
            margin-right: unset; /* Reset margin-right */
            text-align: center; /* Teks "Pesan ini telah dihapus" bisa di tengah */
            max-width: 80%; /* Tetap batasi lebar */
            /* Kita perlu mempertahankan posisi asli (own/other) */
        }
        /* Overrides for deleted messages to keep their original alignment */
        .deleted-message.own {
            margin-left: auto; margin-right: 0;
            text-align: right; /* Teks tetap di kanan untuk pesan sendiri yang dihapus */
        }
        .deleted-message.other {
            margin-right: auto; margin-left: 0;
            text-align: left; /* Teks tetap di kiri untuk pesan orang lain yang dihapus */
        }


        .reply {
            font-size: 0.75em; opacity: 0.7;
            margin-bottom: 5px;
            font-style: italic;
            border-left: 3px solid #075e54;
            padding-left: 5px;
            color: #aebac1;
        }

        #reply-preview {
            background: #202c33; color: #e9edef;
            padding: 10px 15px;
            font-size: 0.9em;
            display: none;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid #2a3942;
            position: fixed; left: 0;
            right: 0;
            /* PERBAIKAN: Ditempatkan tepat di atas input-area */
            bottom: var(--input-area-min-height); z-index: 101;
            height: var(--reply-preview-height); /* Tinggi tetap */
        }

        #reply-preview span {
            flex: 1; white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        #reply-preview button {
            background:none; border:none;
            color:#e9edef;
            font-size:1.5em;
            cursor:pointer;
        }

        /* PERBAIKAN: Area input sekarang fixed di bagian bawah */
        #input-area {
            position: fixed; bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 8px; /* Smaller gap */
            padding: 8px 15px; /* Adjust padding */
            background: #202c33; /* Dark input area */
            border-top: 1px solid #2a3942; align-items: center;
            z-index: 102; /* Pastikan di atas reply-preview dan konten chat */
            min-height: var(--input-area-min-height); /* Tinggi minimum */
        }

        /* PERBAIKAN: Menggunakan textarea agar bisa multi-baris otomatis */
        #input {
            flex: 1; padding: 10px 15px; /* Adjust padding */
            font-size: 1em; /* Ukuran font relatif */
            border: none; /* No border */
            border-radius: 20px; /* Pill shape */
            background-color: #2a3942; /* Darker input background */
            color: #e9edef;
            outline: none; /* No outline on focus */
            min-height: 35px; /* Menjaga tinggi input agar tidak gepeng */
            line-height: 1.2; /* Membantu teks agar tidak gepeng */
            resize: none; /* Mencegah user resize textarea */
            overflow-y: auto; /* Izinkan scrollbar jika teks terlalu panjang */
            max-height: 150px; /* Batasi tinggi maksimal textarea agar tidak terlalu besar */
        }

        #send, #uploadBtn {
            width: 45px; /* Round buttons */
            height: 45px;
            border-radius: 50%; background: #008069; /* WhatsApp Green */
            color: white; font-size: 1.5em; /* Ukuran font relatif */
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        #send:hover, #uploadBtn:hover {
            background-color: #006b5a;
        }

        #uploadBtn {
            font-size: 1.2em; /* Smaller icon */
        }

        .msg img {
            max-width: 100%; border-radius: 5px;
            margin-top: 5px;
        }

        .time {
            font-size: 0.7em; opacity: 0.6;
            display: block;
            margin-top: 3px;
            color: #aebac1;
        }

        .own .time {
            text-align: right;
        }

        .other .time {
            text-align: left;
        }

        .sender-name { /* New style for sender name in 'other' messages */
            font-weight: bold; color: #075e54; /* A distinct color for sender name */
            margin-right: 5px;
        }

        /* Sidebar Styles */
        #sidebar {
            width: 0; background-color: #1f2c33; /* Darker sidebar */
            overflow-x: hidden; transition: 0.5s;
            padding-top: 60px;
            position: fixed;
            height: 100%;
            z-index: 100;
            top: 0; left: 0;
            color: #e9edef;
        }

        #sidebar.open {
            width: 250px;
        }

        #sidebar a {
            padding: 8px 8px 8px 32px; text-decoration: none;
            font-size: 25px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        #sidebar a:hover {
            color: #f1f1f1;
        }

        #sidebar .closebtn {
            position: absolute; top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        #sidebar-menu-list ul {
            list-style-type: none; padding: 0;
        }

        #sidebar-menu-list li {
            padding: 10px 32px; font-size: 18px;
            border-bottom: 1px solid #2a3942;
        }

        #sidebar-menu-list li:last-child {
            border-bottom: none;
        }

        #sidebar-menu-list li a {
            color: #e9edef; text-decoration: none;
            display: block;
            padding: 0;
            font-size: 18px;
        }

        #sidebar-menu-list li a:hover {
            color: #008069;
        }

        /* Overlay effect */
        .overlay {
            position: fixed; width: 100%;
            height: 100%;
            top: 0; left: 0;
            right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 99;
            display: none; transition: opacity 0.5s;
        }

        .overlay.active {
            display: block; opacity: 1;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .msg { font-size: 16px; }
            .reply { font-size: 13px; }
            #input { font-size: 16px; }
            #send, #uploadBtn { font-size: 24px; width: 50px; height: 50px;}
            .time { font-size: 12px; }
            #sidebar-toggle { top: 20px; left: 20px; font-size: 36px;}
            .auth-container, .profile-modal { padding: 40px; }
        }

        /* Toast Message for "Press back again to exit" */
        #toastMessage {
            position: fixed; bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 0.9em; z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Allows clicks to pass through */
        }

        #toastMessage.show {
            opacity: 1;
        }

        /* Context Menu for messages */
        #messageContextMenu {
            position: absolute; background-color: #2a3942; /* Darker background */
            border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            overflow: hidden; /* Ensure rounded corners */
        }

        #messageContextMenu ul {
            list-style: none; margin: 0;
            padding: 0;
        }

        #messageContextMenu ul li {
            padding: 10px 15px; color: #e9edef;
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
        }

        #messageContextMenu ul li:hover {
            background-color: #005c4b; /* Highlight on hover */
        }

        /* Styles for Bot Command Suggestions */
        #commandSuggestions {
            position: absolute; bottom: calc(var(--input-area-total-height) + 5px); /* Position above the input area */
            left: 15px; right: 15px;
            background-color: #2a3942; /* Darker background, similar to messageContextMenu */
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 101; /* Above chat but below reply preview */
            max-height: 200px; /* Limit height and make it scrollable */
            overflow-y: auto; display: none; /* Hidden by default */
        }

        #commandSuggestions ul {
            list-style: none; padding: 0;
            margin: 0;
        }

        #commandSuggestions li {
            padding: 10px 15px; color: #e9edef;
            cursor: pointer;
            font-size: 0.95em;
            border-bottom: 1px solid #33444d; /* Separator between commands */
        }

        #commandSuggestions li:last-child {
            border-bottom: none;
        }

        #commandSuggestions li:hover {
            background-color: #005c4b; /* Highlight on hover */
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="loadingScreen">
        <div id="loadingSpinner"></div>
        <span>Memuat ZedxChat...</span>
    </div>

    <div class="auth-container" id="loginScreen">
        <h2>Login ke ZedxChat</h2>
        <div class="input-group">
            <label for="loginEmail">Email:</label>
            <input type="email" id="loginEmail" placeholder="Masukkan email Anda" required />
        </div>
        <div class="input-group">
            <label for="loginPassword">Password:</label>
            <input type="password" id="loginPassword" placeholder="Masukkan password Anda" required />
        </div>
        <div class="button-group">
            <button id="loginBtn" class="auth-button">Login</button>
        </div>
        <p id="loginMessage" class="auth-message"></p>
        <p class="switch-auth-mode">Belum punya akun? <a href="#" id="goToRegister">Buat Akun di sini</a></p>
    </div>

    <div class="auth-container" id="registerScreen">
        <h2>Daftar Akun Baru</h2>
        <div class="input-group">
            <label for="registerEmail">Email:</label>
            <input type="email" id="registerEmail" placeholder="Masukkan email Anda" required />
        </div>
        <div class="input-group">
            <label for="registerPassword">Password:</label>
            <input type="password" id="registerPassword" placeholder="Minimal 6 karakter" required />
        </div>
        <div class="button-group">
            <button id="registerBtn" class="auth-button">Daftar</button>
        </div>
        <p id="registerMessage" class="auth-message"></p>
        <p class="switch-auth-mode">Sudah punya akun? <a href="#" id="goToLogin">Login di sini</a></p>
    </div>

    <div id="chatListContainer">
        <div id="chatListHeader">
            <h1>ZedxChat</h1>
            <button id="lobbyLogoutBtn">Logout</button>
            <button id="viewProfileBtn">👤</button>
        </div>
        <div id="moneyDisplay">
            Money: <span id="userMoney">0</span>
        </div>
        <div id="chatListContent">
            </div>

        <div id="bottomNav">
            <div class="nav-item active" id="navChat">
                <i class="fas fa-comment-dots"></i>
                <span>Chat</span>
            </div>
        </div>
    </div>

    <div class="auth-container" id="profileModal" style="display:none;">
        <h2>Profil Anda</h2>
        <p>Email: <strong id="profileEmail"></strong></p>
        <div class="input-group">
            <label for="profileDisplayName">Nama Pengguna (Username):</label>
            <input type="text" id="profileDisplayName" placeholder="Atur nama pengguna Anda" required />
        </div>
        <button id="saveProfileBtn" style="background-color: #008069; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Simpan</button>
        <button onclick="closeProfileModal()" style="background-color: #555; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Tutup</button>
        <p id="profileMessage" style="margin-top: 10px; color: red;"></p>
    </div>

    <div id="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <div id="sidebar-menu-list">
            <ul>
                <li><a href="#" onclick="openProfileModal()">Profil Saya</a></li>
                <li><a href="#">Pengaturan Notifikasi</a></li>
                <li><a href="#">Privasi dan Keamanan</a></li>
                <li><a href="#">Bantuan</a></li>
                <li><a href="#">Tentang Aplikasi</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </div>
    <div class="overlay" id="fullScreenOverlay" onclick="closeNav(); closeProfileModal(); hideMessageContextMenu(); hideCommandSuggestions();"></div>

    <span id="sidebar-toggle" onclick="openNav()">&#9776;</span>

    <div id="main-content">
        <div id="chat-header">
            <button id="backToChatListBtn">&#8249;</button>
            <h2 id="currentChatName"></h2>
        </div>
        <div id="chat-container"></div>
        <div id="commandSuggestions">
            <ul>
                </ul>
        </div>
        <div id="reply-preview">
            <span id="reply-text"></span>
            <button onclick="cancelReply()" style="background:none;border:none;color:white;font-size:1.5em;">✕</button>
        </div>
        <div id="input-area">
            <button id="uploadBtn">⬆️</button>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" />
            <textarea id="input" placeholder="Ketik pesan..." rows="1"></textarea>
            <button id="send">Kirim</button>
        </div>
    </div>

    <div id="messageContextMenu">
        <ul>
            <li id="contextDelete">Hapus Pesan</li>
        </ul>
    </div>

    <div id="toastMessage">Tekan kembali sekali lagi untuk keluar</div>

    <script>
        // GANTI DENGAN KUNCI API IMGBB ANDA
        const imgbbKey = "a12e3657b8edd041c13eda8c12ff5925"; // Example key, get yours from imgbb.com/api

        // Firebase objects are now from shared.js
        const db = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage(); // Get storage from shared.js for consistency

        const PUBLIC_CHAT_ID = "publicChat"; // Fixed ID for the public chat in Firebase DB
        const REPORT_CHAT_ID = "reportChat"; // Fixed ID for the report chat
        const TEXT_TO_MONEY_RATE = 100; // 1 money per 100 characters

        let currentLoggedInUser = null; // Firebase User Object, will have .isAdmin property
        let currentDisplayName = "Anonim"; // Display Name for chat
        let currentScreen = 'loading'; // Keep track of the current active screen

        let backButtonPressedOnce = false; // For double-tap to exit logic
        let backButtonTimeout; // To clear the double-tap timeout

        let currentChatId = null; // Menambahkan variabel untuk melacak chat yang sedang aktif
        let currentChatListener = null; // Menambahkan variabel untuk melacak listener chat

        // Variables for context menu
        let currentContextMenuMessage = null; // Stores message data for context menu actions

        // Variables for swipe gesture
        let initialX = null;
        let initialY = null;
        const SWIPE_THRESHOLD = 50; // Minimum horizontal swipe distance to trigger reply
        const VERTICAL_THRESHOLD = 20; // Maximum vertical deviation for a horizontal swipe
        let swipedElement = null; // To keep track of the element being swiped

        // Bot Commands
        const botCommands = [
            { command: "report", description: "Laporkan pesan atau pengguna yang melanggar aturan." },
            { command: "help", description: "Dapatkan bantuan dan informasi tentang bot." },
            { command: "system", description: "Menampilkan informasi simulasi sistem (RAM, CPU, Uptime, Core)." }
        ];

        // --- UI Elements ---
        // Loading Screen
        const loadingScreen = document.getElementById("loadingScreen");

        // Auth UI - Separated
        const loginScreen = document.getElementById("loginScreen");
        const loginEmailInput = document.getElementById("loginEmail");
        const loginPasswordInput = document.getElementById("loginPassword");
        const loginBtn = document.getElementById("loginBtn");
        const loginMessageEl = document.getElementById("loginMessage");
        const goToRegisterLink = document.getElementById("goToRegister");

        const registerScreen = document.getElementById("registerScreen");
        const registerEmailInput = document.getElementById("registerEmail");
        const registerPasswordInput = document.getElementById("registerPassword");
        const registerBtn = document.getElementById("registerBtn");
        const registerMessageEl = document.getElementById("registerMessage");
        const goToLoginLink = document.getElementById("goToLogin");

        // Chat List UI
        const chatListContainer = document.getElementById('chatListContainer');
        const chatListContent = document.getElementById('chatListContent');
        const lobbyLogoutBtn = document.getElementById('lobbyLogoutBtn');
        const viewProfileBtn = document.getElementById('viewProfileBtn');
        const userMoneySpan = document.getElementById('userMoney'); // For lobby money display

        // Profile Modal
        const profileModal = document.getElementById('profileModal');
        const profileEmailEl = document.getElementById('profileEmail');
        const profileDisplayNameInput = document.getElementById('profileDisplayName');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const profileMessageEl = document.getElementById('profileMessage');

        // Main Chat UI
        const mainContent = document.getElementById("main-content");
        const chatHeader = document.getElementById("chat-header");
        const backToChatListBtn = document.getElementById("backToChatListBtn");
        const currentChatNameEl = document.getElementById("currentChatName");
        const chatContainer = document.getElementById("chat-container");
        const inputArea = document.getElementById("input-area");
        const messageInput = document.getElementById("input");
        const sendButton = document.getElementById("send");
        const uploadButton = document.getElementById("uploadBtn");
        const fileInput = document.getElementById("fileInput");
        const replyPreview = document.getElementById("reply-preview");
        const replyText = document.getElementById("reply-text");
        const cancelReplyButton = replyPreview.querySelector('button');
        let replyingToMessageId = null; // ID pesan yang sedang di-reply
        let replyingToMessageContent = null; // Konten pesan yang sedang di-reply

        // Context Menu
        const messageContextMenu = document.getElementById("messageContextMenu");
        const contextDeleteBtn = document.getElementById("contextDelete");
        let activeMessageElement = null; // To store the message element for context menu

        // Bot Command Suggestions
        const commandSuggestions = document.getElementById('commandSuggestions');
        const commandSuggestionsList = commandSuggestions.querySelector('ul');

        // Sidebar
        const sidebar = document.getElementById("sidebar");
        const fullScreenOverlay = document.getElementById("fullScreenOverlay");

        // Bottom Navigation (only Chat now)
        const bottomNav = document.getElementById('bottomNav');
        const navChat = document.getElementById('navChat');


        // --- Auth Functions ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentLoggedInUser = user;
                db.ref('users/' + user.uid).once('value', (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        currentDisplayName = userData.displayName || user.email.split('@')[0];
                        currentLoggedInUser.isAdmin = userData.isAdmin || false; // Set isAdmin flag
                        profileDisplayNameInput.value = currentDisplayName; // Update profile input
                    } else {
                        // If user data doesn't exist, create it (e.g., first-time login)
                        db.ref('users/' + user.uid).set({
                            displayName: user.email.split('@')[0],
                            email: user.email,
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            isAdmin: false,
                            money: 0,
                            textCount: 0,
                            cards: {} // Initialize cards for future gacha use
                        }).then(() => {
                            currentDisplayName = user.email.split('@')[0];
                            currentLoggedInUser.isAdmin = false;
                            profileDisplayNameInput.value = currentDisplayName;
                        }).catch(error => {
                            console.error("Error initializing user data:", error);
                        });
                    }
                    updateUserInfoDisplay();
                    hideAuthScreens();
                    showChatListScreen();
                });
            } else {
                currentLoggedInUser = null;
                currentDisplayName = "Anonim";
                updateUserInfoDisplay();
                hideLoadingScreen();
                showLoginScreen();
            }
        });

        goToRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            showRegisterScreen();
        });

        goToLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            showLoginScreen();
        });

        loginBtn.addEventListener("click", () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) {
                loginMessageEl.textContent = "Email dan password harus diisi.";
                return;
            }
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    loginMessageEl.textContent = "Login berhasil!";
                    // Handled by auth.onAuthStateChanged
                })
                .catch((error) => {
                    loginMessageEl.textContent = "Login gagal: " + error.message;
                });
        });

        registerBtn.addEventListener("click", () => {
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            if (!email || !password || password.length < 6) {
                registerMessageEl.textContent = "Email dan password minimal 6 karakter harus diisi.";
                return;
            }
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    registerMessageEl.textContent = "Registrasi berhasil! Anda bisa login sekarang.";
                    showLoginScreen(); // Redirect to login after successful registration
                })
                .catch((error) => {
                    registerMessageEl.textContent = "Registrasi gagal: " + error.message;
                });
        });

        lobbyLogoutBtn.addEventListener('click', logout);

        // --- UI State Management ---
        function hideAllScreens() {
            loadingScreen.style.display = 'none';
            loginScreen.style.display = 'none';
            registerScreen.style.display = 'none';
            chatListContainer.style.display = 'none';
            mainContent.style.display = 'none';
            profileModal.style.display = 'none';
            fullScreenOverlay.classList.remove('active');
        }

        function showLoadingScreen() {
            hideAllScreens();
            loadingScreen.style.display = 'flex';
            currentScreen = 'loading';
        }

        function hideLoadingScreen() {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                loadingScreen.style.opacity = '1'; // Reset for next time
            }, 500);
        }

        function hideAuthScreens() {
            loginScreen.style.display = 'none';
            registerScreen.style.display = 'none';
        }

        function showLoginScreen() {
            hideAllScreens();
            loginScreen.style.display = 'block';
            loginMessageEl.textContent = ''; // Clear previous messages
            currentScreen = 'login';
        }

        function showRegisterScreen() {
            hideAllScreens();
            registerScreen.style.display = 'block';
            registerMessageEl.textContent = ''; // Clear previous messages
            currentScreen = 'register';
        }

        function showChatListScreen() {
            hideAllScreens();
            chatListContainer.style.display = 'flex';
            bottomNav.style.display = 'flex';
            currentScreen = 'chatList';
            populateChatList(); // Ensure chat list is populated
            setActiveNavItem('navChat'); // Set Chat nav item active
        }

        function showMainChatScreen(chatId, chatName) {
            hideAllScreens();
            mainContent.style.display = 'flex';
            bottomNav.style.display = 'flex';
            currentChatId = chatId;
            currentChatNameEl.textContent = chatName;
            setupChatListener(chatId); // Set up listener for the selected chat
            currentScreen = 'mainChat';
            scrollToBottom(); // Scroll to bottom when chat opens
            setActiveNavItem('navChat'); // Keep Chat nav item active
        }

        function setActiveNavItem(id) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        // --- Profile Modal ---
        viewProfileBtn.addEventListener('click', openProfileModal);

        function openProfileModal() {
            if (currentLoggedInUser) {
                profileEmailEl.textContent = currentLoggedInUser.email;
                profileDisplayNameInput.value = currentDisplayName; // Load current display name
                profileMessageEl.textContent = ''; // Clear message
                profileModal.style.display = 'block';
                fullScreenOverlay.classList.add('active'); // Show overlay
                currentScreen = 'profile';
            } else {
                showToast('Anda harus login untuk melihat profil.', 'error');
            }
        }

        function closeProfileModal() {
            profileModal.style.display = 'none';
            fullScreenOverlay.classList.remove('active'); // Hide overlay
            // Revert screen state based on what was active before opening modal
            if (chatListContainer.style.display === 'flex') {
                currentScreen = 'chatList';
            } else if (mainContent.style.display === 'flex') {
                currentScreen = 'mainChat';
            } else {
                currentScreen = 'loading'; // Fallback
            }
        }

        saveProfileBtn.addEventListener('click', () => {
            const newDisplayName = profileDisplayNameInput.value.trim();
            if (newDisplayName && currentLoggedInUser) {
                db.ref('users/' + currentLoggedInUser.uid).update({
                    displayName: newDisplayName
                }).then(() => {
                    currentDisplayName = newDisplayName; // Update local variable
                    updateUserInfoDisplay(); // Update all UI displays
                    profileMessageEl.textContent = 'Profil berhasil diperbarui!';
                    profileMessageEl.style.color = '#008069';
                    setTimeout(() => {
                        profileMessageEl.textContent = '';
                    }, 3000);
                }).catch(error => {
                    profileMessageEl.textContent = 'Gagal memperbarui profil: ' + error.message;
                    profileMessageEl.style.color = 'red';
                });
            } else {
                profileMessageEl.textContent = 'Nama pengguna tidak boleh kosong.';
                profileMessageEl.style.color = 'red';
            }
        });

        // Function to update user info across all relevant UI elements
        function updateUserInfoDisplay() {
            if (currentLoggedInUser) {
                // Update money display in lobby and game pages
                // Money display is handled by shared.js now
                // Ensure the element userMoneySpan exists in index.html for this to work
                // No need to set up a new listener here, shared.js already does it
                // Just trigger an update if the element is present
                if (userMoneySpan) {
                    db.ref('users/' + currentLoggedInUser.uid + '/money').once('value', (snapshot) => {
                        const money = snapshot.val() || 0;
                        userMoneySpan.textContent = money;
                    });
                }
                // Update display name in profile modal if open, etc.
                if (profileDisplayNameInput) profileDisplayNameInput.value = currentDisplayName;
            }
        }

        // --- Chat List Functions ---
        function populateChatList() {
            chatListContent.innerHTML = ''; // Clear existing list
            // Public Chat
            const publicChatItem = document.createElement('div');
            publicChatItem.classList.add('chat-list-item');
            publicChatItem.innerHTML = `
                <div class="chat-avatar">P</div>
                <div>
                    <h3>Public Chat</h3>
                    <p>Obrolan umum untuk semua pengguna.</p>
                </div>
            `;
            publicChatItem.addEventListener('click', () => {
                showMainChatScreen(PUBLIC_CHAT_ID, 'Public Chat');
            });
            chatListContent.appendChild(publicChatItem);

            // Kusuriya / Gacha Item
            const kusuriyaItem = document.createElement('div');
            kusuriyaItem.classList.add('chat-list-item');
            kusuriyaItem.innerHTML = `
                <div class="chat-avatar" style="background-color: #ffc107;">K</div>
                <div>
                    <h3>Kusuriya</h3>
                    <p>Halaman Gacha/Kartu</p>
                </div>
            `;
            kusuriyaItem.addEventListener('click', () => {
                // Redirect to gacha.html
                window.location.href = 'gacha.html';
            });
            chatListContent.appendChild(kusuriyaItem);

            // If user is admin, show Report Chat
            if (currentLoggedInUser && currentLoggedInUser.isAdmin) {
                const reportChatItem = document.createElement('div');
                reportChatItem.classList.add('chat-list-item');
                reportChatItem.innerHTML = `
                    <div class="chat-avatar" style="background-color: #dc3545;">R</div>
                    <div>
                        <h3>Report Chat (Admin)</h3>
                        <p>Pesan yang dilaporkan pengguna.</p>
                    </div>
                `;
                reportChatItem.addEventListener('click', () => {
                    showMainChatScreen(REPORT_CHAT_ID, 'Report Chat (Admin)');
                });
                chatListContent.appendChild(reportChatItem);
            }
        }

        // --- Main Chat Functions ---
        backToChatListBtn.addEventListener("click", () => {
            if (currentChatListener) {
                db.ref(`chats/${currentChatId}`).off('child_added', currentChatListener);
                currentChatListener = null;
            }
            showChatListScreen();
        });

        function setupChatListener(chatId) {
            // Remove previous listener if any
            if (currentChatListener) {
                db.ref(`chats/${currentChatId}`).off('child_added', currentChatListener);
            }
            chatContainer.innerHTML = ''; // Clear existing messages

            currentChatListener = db.ref(`chats/${chatId}`).on('child_added', (snapshot) => {
                const message = snapshot.val();
                message.id = snapshot.key; // Store the message ID
                displayMessage(message);
                scrollToBottom();
            });
        }

        function displayMessage(message) {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("msg");
            msgDiv.dataset.messageId = message.id; // Set data attribute for ID
            msgDiv.dataset.senderUid = message.uid; // Set sender UID for checking ownership

            let messageContent = '';
            if (message.deleted) {
                msgDiv.classList.add('deleted-message');
                messageContent = 'Pesan ini telah dihapus';
            } else {
                messageContent = message.text;
                if (message.imageUrl) {
                    messageContent += `<br><img src="${message.imageUrl}" alt="Image" loading="lazy">`;
                }
            }

            // Display replied message if exists and not deleted
            if (message.replyTo && !message.deleted) {
                const replyContent = message.replyTo.content.length > 50 ?
                                     message.replyTo.content.substring(0, 50) + '...' :
                                     message.replyTo.content;
                msgDiv.innerHTML += `<div class="reply">Membalas <strong>${message.replyTo.senderName}</strong>: ${replyContent}</div>`;
            }


            db.ref('users/' + message.uid).once('value', (snapshot) => {
                const senderData = snapshot.val();
                const senderDisplayName = senderData ? senderData.displayName : 'Unknown User';

                if (message.uid === currentLoggedInUser.uid) {
                    msgDiv.classList.add("own");
                } else {
                    msgDiv.classList.add("other");
                    // Only show sender name for 'other' messages if not deleted
                    if (!message.deleted) {
                        msgDiv.innerHTML += `<span class="sender-name">${senderDisplayName}</span>`;
                    }
                }
                msgDiv.innerHTML += `<p>${messageContent}</p><span class="time">${formatTimestamp(message.timestamp)}</span>`;

                chatContainer.appendChild(msgDiv);
                scrollToBottom();

                // Add event listeners for context menu and swipe
                if (!message.deleted) { // Only add context menu/swipe for non-deleted messages
                    msgDiv.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showContextMenu(e, message);
                    });

                    // Swipe listeners
                    msgDiv.addEventListener('touchstart', handleTouchStart, false);
                    msgDiv.addEventListener('touchmove', handleTouchMove, false);
                    msgDiv.addEventListener('touchend', handleTouchEnd, false);
                }
            });
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        sendButton.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) { // Allow Shift + Enter for new line
                e.preventDefault();
                sendMessage();
            }
        });

        messageInput.addEventListener('input', () => {
            adjustInputAreaHeight();
            showCommandSuggestionsHandler(); // Check for command suggestions
        });

        function adjustInputAreaHeight() {
            messageInput.style.height = 'auto'; // Reset height
            messageInput.style.height = messageInput.scrollHeight + 'px'; // Set to scroll height

            // Update CSS variable based on actual input area height
            const currentInputAreaHeight = inputArea.offsetHeight;
            document.documentElement.style.setProperty('--input-area-total-height', `${currentInputAreaHeight}px`);
        }

        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText && !fileInput.files.length) {
                return; // Don't send empty messages
            }

            if (!currentLoggedInUser) {
                showToast("Anda harus login untuk mengirim pesan.", 'error');
                return;
            }

            // Check for bot commands
            if (messageText.startsWith('/')) {
                handleBotCommand(messageText);
                messageInput.value = ''; // Clear input after command
                hideCommandSuggestions();
                return;
            }

            const messageData = {
                uid: currentLoggedInUser.uid,
                text: messageText,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                replyTo: null // Default null
            };

            // If replying, add replyTo data
            if (replyingToMessageId && replyingToMessageContent) {
                messageData.replyTo = {
                    messageId: replyingToMessageId,
                    senderName: getSenderNameFromMessageId(replyingToMessageId), // Get sender name of original message
                    content: replyingToMessageContent
                };
            }

            // Upload image if selected
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const storageRef = storage.ref(`chat_images/${currentChatId}/${Date.now()}_${file.name}`);
                const uploadTask = storageRef.put(file);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Progress function (optional)
                        showToast('Mengunggah gambar: ' + Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100) + '%', 'info', 5000);
                    },
                    (error) => {
                        // Error function
                        showToast('Gagal mengunggah gambar: ' + error.message, 'error');
                        console.error("Upload error:", error);
                    },
                    () => {
                        // Complete function
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            messageData.imageUrl = downloadURL;
                            db.ref(`chats/${currentChatId}`).push(messageData);
                            incrementUserTextCount(messageText.length); // Increment text count for money
                            resetInput();
                            cancelReply(); // Clear reply after sending
                            showToast('Gambar berhasil diunggah dan pesan dikirim!', 'success');
                        });
                    }
                );
            } else {
                // No image, just send text message
                db.ref(`chats/${currentChatId}`).push(messageData);
                incrementUserTextCount(messageText.length); // Increment text count for money
                resetInput();
                cancelReply(); // Clear reply after sending
            }
        }

        function resetInput() {
            messageInput.value = '';
            fileInput.value = ''; // Clear selected file
            messageInput.style.height = 'auto'; // Reset textarea height
            document.documentElement.style.setProperty('--input-area-total-height', `${inputArea.offsetHeight}px`); // Reset CSS variable
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // --- Money System ---
        function incrementUserTextCount(charsSent) {
            if (!currentLoggedInUser) return;

            const userTextCountRef = db.ref('users/' + currentLoggedInUser.uid + '/textCount');
            userTextCountRef.transaction((currentCount) => {
                const newCount = (currentCount || 0) + charsSent;
                if (Math.floor(newCount / TEXT_TO_MONEY_RATE) > Math.floor((currentCount || 0) / TEXT_TO_MONEY_RATE)) {
                    // Award money if a new TEXT_TO_MONEY_RATE block is completed
                    const moneyAwarded = Math.floor(newCount / TEXT_TO_MONEY_RATE) - Math.floor((currentCount || 0) / TEXT_TO_MONEY_RATE);
                    db.ref('users/' + currentLoggedInUser.uid + '/money').transaction((currentMoney) => {
                        return (currentMoney || 0) + moneyAwarded;
                    });
                    showToast(`Anda mendapatkan ${moneyAwarded} Money dari chat!`, 'success');
                }
                return newCount;
            });
        }

        // --- Image Upload ---
        uploadButton.addEventListener('click', () => {
            fileInput.click(); // Trigger file input click
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                showToast(`Gambar dipilih: ${fileInput.files[0].name}`, 'info');
                // You might want to display a preview here
            }
        });

        // --- Context Menu for Messages ---
        function showContextMenu(e, message) {
            currentContextMenuMessage = message;
            activeMessageElement = e.currentTarget; // Store the actual message div

            // Check if current user is admin OR message owner
            const isOwner = message.uid === currentLoggedInUser.uid;
            const isAdmin = currentLoggedInUser.isAdmin;

            // Clear existing context menu items
            messageContextMenu.innerHTML = '<ul></ul>';
            const ul = messageContextMenu.querySelector('ul');

            // Always add Reply option
            const replyOption = document.createElement('li');
            replyOption.textContent = 'Balas Pesan';
            replyOption.addEventListener('click', () => {
                startReply(currentContextMenuMessage);
                hideMessageContextMenu();
            });
            ul.appendChild(replyOption);

            // Add Delete option for owner or admin
            if (isOwner || isAdmin) {
                const deleteOption = document.createElement('li');
                deleteOption.textContent = 'Hapus Pesan';
                deleteOption.addEventListener('click', () => {
                    deleteMessage(currentContextMenuMessage.id);
                    hideMessageContextMenu();
                });
                ul.appendChild(deleteOption);
            }

            // Add Report option if not owner and not admin
            if (!isOwner && !isAdmin) {
                const reportOption = document.createElement('li');
                reportOption.textContent = 'Laporkan Pesan';
                reportOption.addEventListener('click', () => {
                    reportMessage(currentContextMenuMessage);
                    hideMessageContextMenu();
                });
                ul.appendChild(reportOption);
            }

            // Position context menu
            messageContextMenu.style.top = `${e.clientY}px`;
            messageContextMenu.style.left = `${e.clientX}px`;
            messageContextMenu.style.display = 'block';
            fullScreenOverlay.classList.add('active'); // Show overlay
        }

        function hideMessageContextMenu() {
            messageContextMenu.style.display = 'none';
            fullScreenOverlay.classList.remove('active'); // Hide overlay
            currentContextMenuMessage = null;
            activeMessageElement = null;
        }

        // --- Delete Message ---
        function deleteMessage(messageId) {
            if (!currentLoggedInUser) {
                showToast("Anda harus login untuk menghapus pesan.", 'error');
                return;
            }

            const messageRef = db.ref(`chats/${currentChatId}/${messageId}`);
            messageRef.once('value', (snapshot) => {
                const messageData = snapshot.val();
                if (messageData) {
                    // Only allow deletion by owner or admin
                    if (messageData.uid === currentLoggedInUser.uid || currentLoggedInUser.isAdmin) {
                        messageRef.update({
                            text: 'Pesan ini telah dihapus',
                            imageUrl: null, // Remove image if any
                            deleted: true,
                            deletedBy: currentLoggedInUser.uid,
                            deletedAt: firebase.database.ServerValue.TIMESTAMP
                        }).then(() => {
                            showToast('Pesan berhasil dihapus.', 'success');
                            // Visually update the message
                            const msgDiv = document.querySelector(`[data-message-id="${messageId}"]`);
                            if (msgDiv) {
                                msgDiv.innerHTML = `<p>Pesan ini telah dihapus</p><span class="time">${formatTimestamp(messageData.timestamp)}</span>`;
                                msgDiv.classList.add('deleted-message');
                                msgDiv.classList.remove('own', 'other'); // Remove original alignment classes for visual center
                                // Re-apply alignment for deleted if it was own/other
                                if (messageData.uid === currentLoggedInUser.uid) {
                                    msgDiv.classList.add('own');
                                } else {
                                    msgDiv.classList.add('other');
                                }
                            }
                        }).catch(error => {
                            showToast('Gagal menghapus pesan: ' + error.message, 'error');
                            console.error("Delete message error:", error);
                        });
                    } else {
                        showToast('Anda tidak memiliki izin untuk menghapus pesan ini.', 'error');
                    }
                }
            });
        }

        // --- Report Message ---
        function reportMessage(message) {
            if (!currentLoggedInUser) {
                showToast("Anda harus login untuk melaporkan pesan.", 'error');
                return;
            }

            // Prevent reporting own message
            if (message.uid === currentLoggedInUser.uid) {
                showToast("Anda tidak dapat melaporkan pesan Anda sendiri.", 'error');
                return;
            }

            const reportData = {
                reporterUid: currentLoggedInUser.uid,
                reportedMessageId: message.id,
                reportedMessageContent: message.text,
                reportedMessageSenderUid: message.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'pending' // pending, reviewed, resolved
            };

            // Push report to a dedicated 'reports' node or directly to 'reportChat'
            db.ref('reports').push(reportData)
                .then(() => {
                    // Also send a simplified message to the report chat for admins to see
                    const reportChatRef = db.ref(`chats/${REPORT_CHAT_ID}`);
                    reportChatRef.push({
                        uid: 'system', // System message
                        text: `Pesan dilaporkan dari ${message.uid}: "${message.text}". ID Pesan: ${message.id}`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        isReport: true, // Custom flag for report messages
                        originalMessageId: message.id
                    });
                    showToast('Pesan berhasil dilaporkan. Terima kasih atas bantuan Anda!', 'success');
                })
                .catch(error => {
                    showToast('Gagal melaporkan pesan: ' + error.message, 'error');
                    console.error("Report message error:", error);
                });
        }

        // --- Reply Functionality ---
        function startReply(message) {
            if (!message || message.deleted) {
                showToast('Tidak bisa membalas pesan yang sudah dihapus.', 'error');
                return;
            }
            replyingToMessageId = message.id;
            replyingToMessageContent = message.text || (message.imageUrl ? '[Gambar]' : ''); // Use [Gambar] if only image
            replyText.innerHTML = `Membalas <strong>${getSenderNameFromMessageId(message.id)}</strong>: ${replyingToMessageContent.length > 30 ? replyingToMessageContent.substring(0, 30) + '...' : replyingToMessageContent}`;
            replyPreview.style.display = 'flex';
            adjustInputAreaHeight(); // Adjust input area position
            messageInput.focus(); // Focus input after starting reply
        }

        function cancelReply() {
            replyingToMessageId = null;
            replyingToMessageContent = null;
            replyPreview.style.display = 'none';
            adjustInputAreaHeight(); // Adjust input area position
        }

        function getSenderNameFromMessageId(messageId) {
            // Find the message element by its data-message-id
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                const senderUid = messageElement.dataset.senderUid;
                // If it's the current user's message
                if (senderUid === currentLoggedInUser.uid) {
                    return currentDisplayName;
                } else {
                    // Try to get sender name from the displayed message itself
                    const senderNameSpan = messageElement.querySelector('.sender-name');
                    if (senderNameSpan) {
                        return senderNameSpan.textContent;
                    }
                    // Fallback if sender name span is not found (e.g., deleted message or very old)
                    return 'Pengguna Lain';
                }
            }
            return 'Pengguna'; // Fallback if message element not found
        }

        // --- Swipe Gesture (for reply) ---
        function handleTouchStart(e) {
            initialX = e.touches[0].clientX;
            initialY = e.touches[0].clientY;
            swipedElement = e.currentTarget; // Store the element being swiped
            swipedElement.style.transition = ''; // Remove transition for immediate feedback
        }

        function handleTouchMove(e) {
            if (initialX === null || initialY === null) {
                return;
            }

            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;

            const diffX = initialX - currentX;
            const diffY = initialY - currentY;

            // Only consider horizontal swipe if vertical movement is minimal
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffY) < VERTICAL_THRESHOLD) {
                // Prevent vertical scrolling while swiping horizontally
                e.preventDefault();
                // Apply transform for visual feedback
                if (diffX > 0) { // Swiping left
                    swipedElement.style.transform = `translateX(${-Math.min(diffX, SWIPE_THRESHOLD * 2)}px)`;
                } else { // Swiping right
                    swipedElement.style.transform = `translateX(${-Math.max(diffX, -SWIPE_THRESHOLD * 2)}px)`;
                }
            } else {
                // If it's more of a vertical scroll, reset transform
                swipedElement.style.transform = '';
            }
        }

        function handleTouchEnd(e) {
            if (initialX === null || swipedElement === null) {
                return;
            }

            const currentX = e.changedTouches[0].clientX;
            const diffX = initialX - currentX;

            if (Math.abs(diffX) > SWIPE_THRESHOLD) {
                // Swipe detected
                if (diffX > 0) { // Swiped left (Reply)
                    const messageId = swipedElement.dataset.messageId;
                    // Retrieve full message object from Firebase if needed, or reconstruct
                    db.ref(`chats/${currentChatId}/${messageId}`).once('value', (snapshot) => {
                        const message = snapshot.val();
                        message.id = messageId;
                        startReply(message);
                    });
                }
            }

            // Reset for next swipe
            swipedElement.style.transition = 'transform 0.2s ease-out'; // Re-enable transition
            swipedElement.style.transform = '';
            initialX = null;
            initialY = null;
            swipedElement = null;
        }

        // --- Bot Command Suggestions ---
        function showCommandSuggestionsHandler() {
            const inputText = messageInput.value;
            if (inputText.startsWith('/')) {
                const query = inputText.substring(1).toLowerCase();
                const filteredCommands = botCommands.filter(cmd =>
                    cmd.command.toLowerCase().startsWith(query) ||
                    cmd.description.toLowerCase().includes(query)
                );
                renderCommandSuggestions(filteredCommands);
                commandSuggestions.style.display = 'block';
            } else {
                hideCommandSuggestions();
            }
        }

        function renderCommandSuggestions(commands) {
            commandSuggestionsList.innerHTML = '';
            if (commands.length === 0) {
                commandSuggestionsList.innerHTML = '<li>Tidak ada perintah ditemukan.</li>';
                return;
            }
            commands.forEach(cmd => {
                const li = document.createElement('li');
                li.textContent = `/${cmd.command} - ${cmd.description}`;
                li.dataset.command = `/${cmd.command}`;
                li.addEventListener('click', () => {
                    messageInput.value = li.dataset.command + ' '; // Auto-fill command
                    messageInput.focus();
                    hideCommandSuggestions();
                    adjustInputAreaHeight();
                });
                commandSuggestionsList.appendChild(li);
            });
        }

        function hideCommandSuggestions() {
            commandSuggestions.style.display = 'none';
        }

        function handleBotCommand(commandText) {
            // Trim leading slash and split into command and arguments
            const parts = commandText.substring(1).split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1);

            let botResponse = '';

            switch (command) {
                case 'report':
                    botResponse = "Untuk melaporkan pesan, tahan pesan yang ingin dilaporkan, lalu pilih 'Laporkan Pesan'.";
                    break;
                case 'help':
                    botResponse = "Selamat datang di ZedxChat! Anda bisa mengetik pesan, membalas (swipe kanan pada pesan), menghapus pesan Anda, dan melaporkan pesan orang lain.";
                    break;
                case 'system':
                    // Simulate system info (not real system data from client)
                    const ram = (Math.random() * 8 + 4).toFixed(2); // 4-12 GB
                    const cpu = (Math.random() * 80 + 10).toFixed(2); // 10-90%
                    const uptime = (Math.random() * 24).toFixed(0); // 0-24 hours
                    const cores = Math.floor(Math.random() * 8) + 2; // 2-9 cores
                    botResponse = `Info Sistem (Simulasi):\nRAM: ${ram} GB\nCPU: ${cpu}%\nUptime: ${uptime} jam\nCore: ${cores}`;
                    break;
                default:
                    botResponse = `Perintah '${command}' tidak dikenal. Ketik /help untuk daftar perintah.`;
            }

            // Send bot's response to the chat
            db.ref(`chats/${currentChatId}`).push({
                uid: 'bot', // Special UID for bot
                text: botResponse,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // --- Sidebar Functions ---
        function openNav() {
            sidebar.classList.add('open');
            fullScreenOverlay.classList.add('active');
        }

        function closeNav() {
            sidebar.classList.remove('open');
            fullScreenOverlay.classList.remove('active');
        }

        // --- Toast Message ---
        function showToast(message, type = 'info', duration = 3000) {
            let toastDiv = document.getElementById('toastMessage');
            if (!toastDiv) { // Create if it doesn't exist
                toastDiv = document.createElement('div');
                toastDiv.id = 'toastMessage';
                document.body.appendChild(toastDiv);
            }

            toastDiv.textContent = message;
            toastDiv.className = `toast-message show ${type}`; // Add type for styling if needed
            clearTimeout(toastDiv.timeoutId); // Clear any existing timeout

            toastDiv.timeoutId = setTimeout(() => {
                toastDiv.classList.remove('show');
            }, duration);
        }

        // --- Hardware Back Button (Android) ---
        document.addEventListener('backbutton', function() {
            if (sidebar.classList.contains('open')) {
                closeNav();
            } else if (profileModal.style.display === 'block') {
                closeProfileModal();
            } else if (messageContextMenu.style.display === 'block') {
                hideMessageContextMenu();
            } else if (commandSuggestions.style.display === 'block') {
                hideCommandSuggestions();
            } else if (replyPreview.style.display === 'flex') {
                cancelReply();
            } else if (currentScreen === 'mainChat') {
                backToChatListBtn.click(); // Simulate clicking back button
            } else if (currentScreen === 'chatList') {
                if (backButtonPressedOnce) {
                    // Implement app exit logic here
                    // navigator.app.exitApp(); // For Cordova/PhoneGap
                    // For web, you might redirect or simply do nothing
                    console.log("Exiting app (simulated)");
                } else {
                    backButtonPressedOnce = true;
                    showToast('Tekan kembali sekali lagi untuk keluar.');
                    backButtonTimeout = setTimeout(() => {
                        backButtonPressedOnce = false;
                    }, 2000); // Reset after 2 seconds
                }
            } else if (currentScreen === 'login' || currentScreen === 'register') {
                if (backButtonPressedOnce) {
                    // navigator.app.exitApp();
                    console.log("Exiting app (simulated)");
                } else {
                    backButtonPressedOnce = true;
                    showToast('Tekan kembali sekali lagi untuk keluar.');
                    backButtonTimeout = setTimeout(() => {
                        backButtonPressedOnce = false;
                    }, 2000);
                }
            }
        });

        // --- Bottom Navigation Event Listeners ---
        navChat.addEventListener('click', showChatListScreen);

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoadingScreen();
            // The auth.onAuthStateChanged listener in shared.js will handle showing the correct screen after Firebase initializes
        });

    </script>
</body>
</html>
